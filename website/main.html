<!DOCTYPE html>
<head>
    <meta charset="UTF-8">
    <title>executor-go</title>

    <style>

        .main {
            background-color: #c4dbf6;
            width: 95%;
            border-radius: 10px;
            padding: 16pt;
        }

        .system_status {
            font-size: 16pt;
        }

        .system_status_runnig {
            font-size: 16pt;
            color: green;
        }

        .system_status_stoped {
            font-size: 16pt;
            color: red;
        }

        .rectangle-button {
            background-color: #659dbd;
            color: white;
            border: none;
            cursor: pointer;
            border-radius: 5px; /* Remove for strict sharp corners */
        }
        .rectangle-button:hover {
            background-color: #558dad;
        }

        .input-name {
            width: 314px;
        }

        .input-cmd {
            width: 95%;
            height: 101pt;
            font-family: 'Courier New', Courier, monospace;
        }

        .tabs {
            max-width: 600px;
            margin: 20px auto;
        }

        .tab-links {
            display: flex;
            list-style: none;
            padding: 0;
            margin: 0;
            border-bottom: 2px solid #ddd;
        }

        .tab-link {
            padding: 10px 20px;
            cursor: pointer;
            background: #f1f1f1;
            border: 1px solid #ddd;
            border-bottom: none;
            margin-right: 5px;
            border-radius: 5px 5px 0 0;
        }

        .tab-link:hover {
            background: #e1e1e1;
        }

        .tab-link.active {
            background: white;
            position: relative;
            top: 2px;
            font-weight: bold;
        }

        .tab-content {
            display: none;
            padding: 20px;
            border: 1px solid #ddd;
            border-top: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Спрячем радиокнопки */
        .tabs input[type="radio"] {
            display: none;
        }
    </style>
</head>
<body>
    <form id="systemForm">
    <div class="main">
        <button type="submit" aria-label="Описание действия" class="rectangle-button" id="system_button">
        <svg xmlns="http://www.w3.org/2000/svg" height="64px" viewBox="0 -960 960 960" width="64px" fill="#e3e3e3">
            <path d="M200-332v-296l220 148-220 148Zm340 12v-320h60v320h-60Zm160 0v-320h60v320h-60Z"/>
        </svg>
        </button>
        <label>status: </label><label id="status_system">STOPPED</label>

        <select style="float: right; font-size: 16pt;" id="jobs" required>
                <option value="1" selected>1</option>
                <option value="2">2</option>
                <option value="3">3</option>
                <option value="4">4</option>
                <option value="5">5</option>
                <option value="6">6</option>
                <option value="7">7</option>
                <option value="8">8</option>
                <option value="16">16</option>
                <option value="32">32</option>
                <option value="64">64</option>
                <option value="128">128</option>
        </select>
        <div style="clear: both;"></div> <!-- Для очистки обтекания -->
    </div>
    </form>

    <div class="form-status">
        <table border=1>
            <tr><td>Задач в очереди:</td><td><p id="tasks_in_wait"><strong>0</strong></p></td></tr>
            <tr><td>Задач в работе:</td><td><p id="tasks_in_run"><strong>0</strong></p></td></tr>
            <tr><td>Задач выполнены:</td><td><p id="tasks_in_done"><strong>0</strong></p></td></tr>
        </table>
    </div>
    <br>
    <form id="userForm">
        <div>
            <label>Команда: </label><br>
            <textarea class="input-cmd" name="comment" id="cmd" placeholder="Введите команду" required></textarea><br>

            <label>Режим запуска: </label>
            <select id="run" required>
                <option value="" disabled selected>Выберите режим запуска</option>
                <option value="1">Последовательный</option>
                <option value="2">Параллельный</option>
            </select><br>

            <label>Режим запуска: </label>
            <select id="limit" required>
                <option value="256" selected>256</option>
                <option value="512">512</option>
                <option value="1024">1024</option>
                <option value="2048">2048</option>
                <option value="4096">4096</option>
            </select>

            <button type="submit" class="rectangle-button">+</button>
        </div>
    </form>
    <br><br>

    <div id="tableContainer"></div>




    <script>

        const sleep = (ms) => new Promise(resolve => setTimeout(resolve, ms));

        // Обработка успешного ответа
        function handleSuccessResponse(response, formData) {
            console.log('Ответ сервера:', response);
        }

        // Обработка ошибки
        function handleErrorResponse(error, formData) {
            console.error('Ошибка отправки:', error);
        }

        // Функция отправки данных на сервер
        async function sendDataToServer(data) {
            const response = await fetch("http://localhost:13666/task/", {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(data)
            });

            // Проверяем, успешен ли ответ
            if (!response.ok) {
                throw new Error(`Ошибка HTTP: ${response.status}`);
            }

            // Пытаемся получить JSON ответ
            try {
                return await response.json();
            } catch (e) {
                // Если ответ не JSON, возвращаем текстовый ответ
                console.log(e)
                return 0;
            }
        }

        document.getElementById('systemForm').addEventListener('submit', async function(event) {
            event.preventDefault();

                // Отправляем данные на сервер
                try {
                    const response = await fetch("http://localhost:13666/system/", {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({})
                });

                // Проверяем, успешен ли ответ
                if (!response.ok) {
                    throw new Error(`Ошибка HTTP: ${response.status}`);
                }

                // Пытаемся получить JSON ответ
                try {
                    var data = await response.json()
                    console.log('Ответ сервера:', data);
                    document.getElementById('status_system').innerHTML = data['status'];
                } catch (e) {
                    // Если ответ не JSON, возвращаем текстовый ответ
                    console.log(e)
                    return 0;
                }
            } catch (error) {
                // Обрабатываем ошибку
                handleErrorResponse(error, formData);
            } finally {
                // Скрываем индикатор загрузки
            }
        });


        document.getElementById('userForm').addEventListener('submit', async function(event) {
            event.preventDefault();

            // Получаем значения из формы
            const formData = {
                cmd: document.getElementById('cmd').value,
                limit: document.getElementById('limit').value,
                run: document.getElementById('run').value
            };

            // Отправляем данные на сервер
            try {
                const response = await sendDataToServer(formData);

                // Обрабатываем успешный ответ
                handleSuccessResponse(response, formData);

                await sleep(1000);
                await onLoadData();
            } catch (error) {
                // Обрабатываем ошибку
                handleErrorResponse(error, formData);
            } finally {
                // Скрываем индикатор загрузки
            }
        });

        async function onLoadData() {
            try {
                // Запрос данных с сервера
                const response = await fetch("http://localhost:13666/task/");

                if (!response.ok) {
                    throw new Error('Ошибка загрузки данных');
                }

                const data = await response.json();
                await renderTable(data);


                const response_w = await fetch("http://localhost:13666/system/");
                const data_w = await response_w.json();
                if (!response_w.ok) {
                    throw new Error('Ошибка загрузки данных');
                }
                document.getElementById('status_system').innerHTML = data_w['status'];
            } catch (error) {
                console.error('Ошибка:', error);
                tableContainer.innerHTML = `<p style="color:red">${error.message}</p>`;
            }
        }

        async function renderTable(data) {
            // Проверяем, что данные - массив
            if (!Array.isArray(data) || data.length === 0) {
                tableContainer.innerHTML = '<p>Нет задач</p>';
                return;
            }

            let count_run = 0;
            let count_wait = 0;
            let count_done = 0;


            // Получаем названия столбцов из ключей первого объекта
            const headers = Object.keys(data[0]);

            // Создаем таблицу
            let html = '<table border=1>';

            // Создаем заголовок таблицы
            html += '<thead><tr>';
            headers.forEach(header => {
                html += `<th>${header}</th>`;
            });
            html += '</tr></thead>';

            // Создаем тело таблицы
            html += '<tbody>';
            data.forEach(row => {
                html += '<tr>';
                headers.forEach(header => {

                    if (header == "status") {
                        if (row[header] == "1") {
                            count_wait = count_wait + 1;
                            html += `<td>waiting</td>`;
                        }
                        if (row[header] == "2") {
                            count_run = count_run + 1;
                            html += `<td>running</td>`;
                        }
                        if (row[header] == "3") {
                            html += `<td>canseled</td>`;
                        }
                        if (row[header] == "4") {
                            html += `<td>failed</td>`;
                        }
                        if (row[header] == "5") {
                            count_done = count_done + 1;
                            html += `<td>done</td>`;
                        }
                    }
                    else {
                        html += `<td>${row[header] || ''}</td>`;
                    }


                });
                html += '</tr>';
            });
            html += '</tbody></table>';

            // Вставляем таблицу в контейнер
            document.getElementById('tableContainer').innerHTML = html;

            document.getElementById('tasks_in_wait').innerHTML = count_wait;
            document.getElementById('tasks_in_run').innerHTML = count_run;
            document.getElementById('tasks_in_done').innerHTML = count_done;
        }

        window.addEventListener('load', async function() {
            await onLoadData();
        });
    </script>
</body>
</html>
