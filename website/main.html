<!DOCTYPE html>
<head>
    <meta charset="UTF-8">
    <title>executor-go</title>
    <style>
        html {
            padding: 2em 1em;
            margin: auto;
        }

        .rect-btn {
            padding-top: 0.2ch;
            background-color: #000000;
            border: none;
            cursor: pointer;
            border-radius: 5px;
        }

        .status-tbl {
            border-spacing: 10px;
            width: 800px;
        }

        .rect-button {
            margin-top: 5pt;
            background-color: #000000;
            font-size: 14pt;
            color: white;
            border: none;
            cursor: pointer;
            border-radius: 5px;
        }

        .input-cmd {
            width: 99%;
            height: 64pt;
            font-family: 'Courier New', Courier, monospace;
            font-size: 10pt;
        }
    </style>
</head>
<body>
    <form id="systemForm">
    <div class="main">
        <button type="submit" aria-label="Описание действия" class="rect-btn" id="system_button">
        <svg xmlns="http://www.w3.org/2000/svg" height="32px" viewBox="0 -960 960 960" width="32px" fill="#e3e3e3">
            <path d="M200-332v-296l220 148-220 148Zm340 12v-320h60v320h-60Zm160 0v-320h60v320h-60Z"/>
        </svg>
        </button>
        <label>status: </label><label id="status_system">STOPPED</label>

        <select style="float: right;" id="jobs" required>
                <option value="1" selected>1</option>
                <option value="2">2</option>
                <option value="3">3</option>
                <option value="4">4</option>
                <option value="5">5</option>
                <option value="6">6</option>
                <option value="7">7</option>
                <option value="8">8</option>
                <option value="16">16</option>
                <option value="32">32</option>
                <option value="64">64</option>
                <option value="128">128</option>
        </select>
        <div style="clear: both;"></div> <!-- Для очистки обтекания -->
    </div>
    </form>

    <div>
        <table class="status-tbl">
            <tr><td>Задач в очереди: <label id="tasks_in_wait">0</label></td>
                <td>Задач в работе:  <label id="tasks_in_run" >0</label></td>
                <td>Задач выполнены: <label id="tasks_in_done">0</label></td>
            </tr>
        </table>
    </div>
    <br>
    <form id="userForm">
        <div>
            <label>Команда: </label><br>
            <textarea class="input-cmd" name="comment" id="cmd" placeholder="Введите команду" required></textarea><br>

            <label>Максимальное число задач, которое может выполняться одновременно с этим процесом: </label>
            <select id="run" required>
                <option value="1" selected>1</option>
                <option value="2">2</option>
                <option value="3">3</option>
                <option value="4">4</option>
                <option value="8">8</option>
                <option value="16">16</option>
                <option value="32">32</option>
                <option value="64">64</option>
            </select><br>

            <label>Режим запуска: </label>
            <select id="limit" required>
                <option value="256" selected>256</option>
                <option value="512">512</option>
                <option value="1024">1024</option>
                <option value="2048">2048</option>
                <option value="4096">4096</option>
                <option value="8192">8192</option>
            </select>

            <button type="submit" class="rect-button">+</button>
        </div>
    </form>
    <br><br>

    <div id="tableContainer"></div>

    <details>
        <summary>Done tasks</summary>
        <div id="tableContainerDoneTask"></div>
    </details>

    <script>
        const sleep = (ms) => new Promise(resolve => setTimeout(resolve, ms));

        // Обработка успешного ответа
        function handleSuccessResponse(response, formData) {
            console.log('Ответ сервера:', response);
        }

        // Обработка ошибки
        function handleErrorResponse(error, formData) {
            console.error('Ошибка отправки:', error);
        }

        // Функция отправки данных на сервер
        async function sendDataToServer(data) {
            const response = await fetch("http://localhost:13666/task/", {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(data)
            });

            // Проверяем, успешен ли ответ
            if (!response.ok) {
                throw new Error(`Ошибка HTTP: ${response.status}`);
            }

            // Пытаемся получить JSON ответ
            try {
                return await response.json();
            } catch (e) {
                // Если ответ не JSON, возвращаем текстовый ответ
                console.log(e)
                return 0;
            }
        }

        document.getElementById('systemForm').addEventListener('submit', async function(event) {
            event.preventDefault();

                // Отправляем данные на сервер
                try {
                    const response = await fetch("http://localhost:13666/system/", {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({})
                });

                // Проверяем, успешен ли ответ
                if (!response.ok) {
                    throw new Error(`Ошибка HTTP: ${response.status}`);
                }

                // Пытаемся получить JSON ответ
                try {
                    var data = await response.json()
                    console.log('Ответ сервера:', data);
                    document.getElementById('status_system').innerHTML = data['status'];
                } catch (e) {
                    // Если ответ не JSON, возвращаем текстовый ответ
                    console.log(e)
                    return 0;
                }
            } catch (error) {
                // Обрабатываем ошибку
                handleErrorResponse(error, formData);
            } finally {
                // Скрываем индикатор загрузки
            }
        });


        document.getElementById('userForm').addEventListener('submit', async function(event) {
            event.preventDefault();

            // Получаем значения из формы
            const formData = {
                cmds: document.getElementById('cmd').value,
                limit: document.getElementById('limit').value,
                run: document.getElementById('run').value
            };

            // Отправляем данные на сервер
            try {
                const response = await sendDataToServer(formData);

                // Обрабатываем успешный ответ
                handleSuccessResponse(response, formData);

                await sleep(1000);
                await onLoadData();
            } catch (error) {
                // Обрабатываем ошибку
                handleErrorResponse(error, formData);
            } finally {
                // Скрываем индикатор загрузки
            }
        });

        async function onLoadData() {
            try {
                // Запрос данных с сервера
                const response = await fetch("http://localhost:13666/task/");

                if (!response.ok) {
                    throw new Error('Ошибка загрузки данных');
                }

                const data = await response.json();
                await renderTable(data);


                const response_w = await fetch("http://localhost:13666/system/");
                const data_w = await response_w.json();
                if (!response_w.ok) {
                    throw new Error('Ошибка загрузки данных');
                }
                document.getElementById('status_system').innerHTML = data_w['status'];
            } catch (error) {
                console.error('Ошибка:', error);
                tableContainer.innerHTML = `<p style="color:red">${error.message}</p>`;
            }
        }

        async function render_table(data) {
            // Проверяем, что данные - массив
            if (!Array.isArray(data) || data.length === 0) {
                tableContainer.innerHTML = '<p>Нет задач</p>';
                return;
            }

            const headers = Object.keys(data[0]);

            let html = '<table border=1>';

            // Создаем заголовок таблицы
            html += '<thead><tr><th> </th>';
            headers.forEach(header => {
                html += `<th>${header}</th>`;
            });
            html += '</tr></thead>';
            html += '<tbody>';

                            // Создаем тело таблицы
            data.forEach(row => {
                html += '<tr>';

                html += `<td><button id="btn_delete-${row["id"]}" >x</button></td>`;
                // строка
                headers.forEach(header => {
                    if (header == "status") {
                        if (row[header] == "1") {
                            html += `<td>waiting</td>`;
                        }
                        if (row[header] == "2") {
                            html += `<td>running</td>`;
                        }
                        if (row[header] == "3") {
                            html += `<td>canseled</td>`;
                        }
                        if (row[header] == "4") {
                            html += `<td>failed</td>`;
                        }
                        if (row[header] == "5") {
                            html += `<td>done</td>`;
                        }
                    }
                    else if (header == "tstart" || header == "tfinish") {
                        let t = `${row[header] || ''}`.replace("T", " ").replace("+03:00", "")
                        html += `<td>${t}</td>`;
                    } else {
                        html += `<td>${row[header] || ''}</td>`;
                    }

                });
                html += '</tr>';
            });
            html += '</tbody></table>';
            return html;
        }

        async function renderTable(data) {
            let count_run = 0;
            let count_wait = 0;
            let count_done = 0;

            let data_done = [];
            let data_wait_run = [];

            if (data.length > 0) {
                data.forEach(row => {
                    if (row["status"] == "3" || row["status"] == "4" || row["status"] == "5") {
                        data_done.push(row);
                        count_done = count_done + 1;
                    }
                    else {
                        if (row["status"] == "1" ) {count_wait = count_wait + 1;}
                        if (row["status"] == "2" ) {count_run = count_run + 1;}
                        data_wait_run.push(row);
                    }
                });
            }

            // Вставляем таблицу в контейнер
            if (count_run + count_wait > 0) {
                document.getElementById('tableContainer').innerHTML = await render_table(data_wait_run);
            }
            else {
                document.getElementById('tableContainer').innerHTML = '<p>Нет задач</p>';
            }

            if (count_done > 0) {
                document.getElementById('tableContainerDoneTask').innerHTML = await render_table(data_done);
            }
            else {
                document.getElementById('tableContainerDoneTask').innerHTML = '<p>Нет задач</p>';
            }

            document.getElementById('tasks_in_wait').innerHTML = count_wait;
            document.getElementById('tasks_in_run').innerHTML = count_run;
            document.getElementById('tasks_in_done').innerHTML = count_done;
        }

        window.addEventListener('load', async function() {
            await onLoadData();
            await set_button_actions();
        });


        async function set_button_actions() {
            // Находим все кнопки по CSS селектору
            const buttons = document.querySelectorAll('[id^="btn_delete-"]');

            // Добавляем обработчики клика
            buttons.forEach(button => {
                // Извлекаем ID из id кнопки (например, "btn_delete-3" -> 3)
                const buttonId = parseInt(button.id.split('-')[1]);


                button.addEventListener('click', async () => {
                    // Сохраняем оригинальный текст кнопки
                    button.disabled = true;

                    try {
                        const response = await fetch("http://localhost:13666/task/", {
                            method: 'DELETE',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify(
                                {"id": buttonId.toString()}
                            )
                        });

                        const data = await response.json();

                        // Выводим результат в консоль
                        console.log(`delete id=${buttonId}:`, data);

                    } catch (error) {
                        console.error(`Ошибка для кнопки ${buttonId}:`, error);
                        alert(`Ошибка при отправке запроса от кнопки ${buttonId}`);
                    } finally {
                    }
                });
            });
        };
    </script>
</body>
</html>
